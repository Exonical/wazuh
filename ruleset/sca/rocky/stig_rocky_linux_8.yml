# Security Configuration Assessment
# STIG Checks for Rocky Linux 8
# Copyright (C) 2015, Wazuh Inc.
#
# This program is free software; you can redistribute it
# and/or modify it under the terms of the GNU General Public
# License (version 2) as published by the FSF - Free Software
# Foundation
#
# Based on:
# Defense Information Systems Agency Security Technical Implementation Guide Red Hat Enterprise Linux 8 Benchmark Version 1, Release 14 - 04-22-2024

policy:
  id: "stig_rocky_linux_8"
  file: "stig_rocky_linux_8.yml"
  name: "DISA STIG Rocky Linux 8 Benchmark Ver 1, Rel 14"
  description: "This document provides prescriptive guidance for establishing a secure configuration posture for Rocky Linux 8 systems running on x86_64 platforms.This document was tested against Rocky Linux 8."
  references:
    - https://public.cyber.mil/stigs/

requirements:
  title: "Check RL8 family platform."
  description: "Requirements for running the policy against RL 8 family."
  condition: any
  rules:
    - 'f:/etc/redhat-release -> r:^Rocky Linux && r:release 8\p*'

variables:
  $sshd_file: /etc/ssh/sshd_config

checks:
  # DISA STIG SEVERITY CATEGORY 1
  # Operating system must not have accounts configured with blank or null passwords. (Automated)
  - id: 5601
    title: "Operating system must not have accounts configured with blank or null passwords."
    description: "If an account has an empty password, anyone could log on and run commands with the privileges of that account."
    rationale: "Accounts with empty passwords should never be used in operational environments."
    remediation: "If any accounts in the /etc/shadow file do not have a password, run the following command to lock the account until it can be determined why it does not have a password: # passwd -l <username> Also, check to see if the account is logged in and investigate what it is being used for to determine if it needs to be forced off."
    compliance:
      - stid_id: ["RHEL-08-010121"]
      - stig_severity: ["1"]
    condition: none
    rules:
      - 'f:/etc/shadow -> !r:^# && r:^\w+::'

  # Must not allow blank or null passwords in the password-auth file.
  - id: 5602
    title: "Must not allow blank or null passwords in the password-auth file"
    description: "If an account has an empty password, anyone could log on and run commands with the privileges of that account."
    rationale: "Accounts with empty passwords should never be used in operational environments."
    remediation: "Remove any instances of the nullok option in the /etc/pam.d/password-auth file to prevent logons with empty passwords"
    compliance:
      - stid_id: ["RHEL-08-020332"]
      - stig_severity: ["1"]
    condition: none
    rules:
      - 'f:/etc/pam.d/password-auth -> !r:^# && r:nullok'

  # Must not allow blank or null passwords in the system-auth file.
  - id: 5603
    title: "Must not allow blank or null passwords in the system-auth file."
    description: "If an account has an empty password, anyone could log on and run commands with the privileges of that account."
    rationale: "Accounts with empty passwords should never be used in operational environments."
    remediation: "Remove any instances of the nullok option in the /etc/pam.d/system-auth file to prevent logons with empty passwords"
    compliance:
      - stid_id: ["RHEL-08-020331"]
      - stig_severity: ["1"]
    condition: none
    rules:
      - 'f:/etc/pam.d/system-auth -> !r:^# && r:nullok'

  # A File Transfer Protocol (FTP) server package must not be installed unless mission essential.
  - id: 5604
    title: "A File Transfer Protocol (FTP) server package must not be installed unless mission essential."
    description: "The FTP service provides an unencrypted remote access that does not provide for the confidentiality and integrity of user passwords or the remote session."
    rationale: "If a privileged user were to log on using this service, the privileged user password could be compromised. SSH or other encrypted file transfer methods must be used in place of this service."
    remediation: "Verify an FTP server has not been installed on the system"
    compliance:
      - stid_id: ["RHEL-08-040360"]
      - stig_severity: ["1"]
    condition: all
    rules:
      - "c:rpm -q vsftpd -> r:^package vsftpd is not installed"
      - "c:rpm -q ftp -> r:^package ftp is not installed"

  # Ensure root account is the only account having unrestricted access to the system. (Automated)
  - id: 5605
    title: "Ensure root account is the only account having unrestricted access to the system."
    description: "If an account other than root also has a User Identifier (UID) of 0, it has root authority, giving that account unrestricted access to the entire operating system."
    rationale: 'Multiple accounts with a UID of 0 afford an opportunity for potential intruders to guess a password for a privileged account.'
    remediation: "Remove any users other than root with UID 0 or assign them a new UID if appropriate."
    compliance:
      - stid_id: ["RHEL-08-040200"]
      - stig_severity: ["1"]
    condition: none
    rules:
      - 'f:/etc/passwd -> !r:^\s*root && n:^\w+:\S*:(\d+):\S*:\S*:\S*:\S* compare == 0'

  # The Trivial File Transfer Protocol (TFTP) server package must not be installed if not required for operational support. (Automated)
  - id: 5606
    title: "The Trivial File Transfer Protocol (TFTP) server package must not be installed if not required for operational support."
    description: "Trivial File Transfer Protocol (TFTP) is a simple protocol for exchanging files between two TCP/IP machines. TFTP servers allow connections from a TFTP Client for sending and receiving files."
    rationale: "TFTP does not have built-in encryption, access control or authentication. This makes it very easy for an attacker to exploit TFTP to gain access to files."
    remediation: "Run the following command to remove tftp-server: # dnf remove tftp-server."
    compliance:
      - stid_id: ["RHEL-08-040190"]
      - stig_severity: ["1"]
    condition: all
    rules:
      - "c:rpm -q tftp-server -> r:^package tftp-server is not installed"

  # The systemd Ctrl-Alt-Delete burst key sequence must be disabled. (Automated)
  - id: 5607
    title: "The systemd Ctrl-Alt-Delete burst key sequence must be disabled."
    description: "A locally logged-on user who presses Ctrl-Alt-Delete when at the console can reboot the system."
    rationale: "If accidentally pressed, as could happen in the case of a mixed OS environment, this can create the risk of short-term loss of availability of systems due to unintentional reboot."
    remediation: "Verify operating system is not configured to reboot the system when Ctrl-Alt-Delete is pressed seven times within two seconds."
    compliance:
      - stid_id: ["RHEL-08-040172"]
      - stig_severity: ["1"]
    condition: none
    rules:
      - 'f:/etc/systemd/system.conf -> !r:^# && r:^CtrlAltDelBurstAction=(?!none).+'

  # The x86 Ctrl-Alt-Delete key sequence must be disabled if a graphical user interface is installed. (Automated)
  - id: 5608
    title: "The x86 Ctrl-Alt-Delete key sequence must be disabled if a graphical user interface is installed."
    description: "A locally logged-on user who presses Ctrl-Alt-Delete when at the console can reboot the system."
    rationale: "If accidentally pressed, as could happen in the case of a mixed OS environment, this can create the risk of short-term loss of availability of systems due to unintentional reboot."
    remediation: "Verify operating system is not configured to reboot the system when Ctrl-Alt-Delete is pressed when using a graphical user interface."
    compliance:
      - stid_id: ["RHEL-08-040171"]
      - stig_severity: ["1"]
    condition: none
    rules:
      - 'f:/usr/bin/gnome-shell -> !exists'
      - 'f:/etc/dconf/db/local.d/* -> !r:^# && !r:^logout=""'

  # The x86 Ctrl-Alt-Delete key sequence must be disabled. (Automated)
  - id: 5609
    title: "The x86 Ctrl-Alt-Delete key sequence must be disabled."
    description: "A locally logged-on user who presses Ctrl-Alt-Delete when at the console can reboot the system."
    rationale: "If accidentally pressed, as could happen in the case of a mixed OS environment, this can create the risk of short-term loss of availability of systems due to unintentional reboot."
    remediation: "Verify operating system is not configured to reboot the system when Ctrl-Alt-Delete is pressed when using a graphical user interface."
    compliance:
      - stid_id: ["RHEL-08-040170"]
      - stig_severity: ["1"]
    condition: all
    rules:
      - "c:systemctl status ctrl-alt-del.target -> r:inactive"
      - "c:systemctl is-enabled ctrl-alt-del.target -> r:disabled"
      - "c:systemctl is-enabled ctrl-alt-del.target -> r:masked"

  # The rsh-server package must not be installed. (Automated)
  - id: 5610
    title: "The rsh-server package must not be installed."
    description: "It is detrimental for operating systems to provide, or install by default, functionality exceeding requirements or mission objectives."
    rationale: "These unnecessary capabilities or services are often overlooked and therefore may remain unsecured. They increase the risk to the platform by providing additional attack vectors"
    remediation: "Run the following command to remove rsh-server: # dnf remove rsh-server."
    compliance:
      - stid_id: ["RHEL-08-040010"]
      - stig_severity: ["1"]
    condition: all
    rules:
      - "c:rpm -q rsh-server -> r:^package rsh-server is not installed"

  # The telnet-server package must not be installed. (Automated)
  - id: 5611
    title: "The telnet-server package must not be installed."
    description: "It is detrimental for operating systems to provide, or install by default, functionality exceeding requirements or mission objectives."
    rationale: "These unnecessary capabilities or services are often overlooked and therefore may remain unsecured. They increase the risk to the platform by providing additional attack vectors"
    remediation: "Run the following command to remove telnet-server: # dnf remove telnet-server."
    compliance:
      - stid_id: ["RHEL-08-040000"]
      - stig_severity: ["1"]
    condition: all
    rules:
      - "c:rpm -q telnet-server -> r:^package telnet-server is not installed"

  # The system must not allow accounts configured with blank or null passwords.
  - id: 5612
    title: "The system must not allow accounts configured with blank or null passwords."
    description: "If an account has an empty password, anyone could log on and run commands with the privileges of that account. Accounts with empty passwords should never be used in operational environments."
    rationale: "Accounts with empty passwords could lead to unauthorized access and should be disabled in operational environments."
    remediation: "Edit the following line in /etc/ssh/sshd_config to prevent logons with empty passwords: PermitEmptyPasswords no."
    compliance:
      - stid_id: ["RHEL-08-020330"]
      - stig_severity: ["1"]
    condition: none
    rules:
      - 'f:/etc/ssh/sshd_config -> !r:^# && r:^PermitEmptyPasswords no'
      - 'f:/etc/ssh/sshd_config -> !r:^# && r:^PermitEmptyPasswords yes'

  # Unattended or automatic logon via the graphical user interface must not be allowed.
  - id: 5613
    title: "Unattended or automatic logon via the graphical user interface must not be allowed."
    description: "Failure to restrict system access to authenticated users negatively impacts operating system security."
    rationale: "Unattended or automatic logon without authentication could allow unauthorized users to access the system."
    remediation: "Edit the /etc/gdm/custom.conf file and set 'AutomaticLoginEnable=false' in the [daemon] section."
    compliance:
      - stid_id: ["RHEL-08-010820"]
      - stig_severity: ["1"]
    condition: none
    rules:
      - 'f:/etc/gdm/custom.conf -> !r:^# && r:^AutomaticLoginEnable=false'
      - 'f:/etc/gdm/custom.conf -> !r:^# && r:^AutomaticLoginEnable=(?!false).+'

  # There must be no .shosts files on the RHEL 8 operating system.
  - id: 5614
    title: "There must be no .shosts files on the RHEL 8 operating system."
    description: "The '.shosts' files are used to configure host-based authentication for individual users or the system via SSH. Host-based authentication is not sufficient for preventing unauthorized access."
    rationale: "Host-based authentication does not provide sufficient protection against unauthorized access as it bypasses interactive identification and two-factor authentication."
    remediation: "Remove any found '.shosts' files from the system."
    compliance:
      - stid_id: ["RHEL-08-010470"]
      - stig_severity: ["1"]
    condition: none
    rules:
      # Check if any .shosts files are present
      - 'c:find / -name "*.shosts" 2>/dev/null -> !r:.'

  # There must be no shosts.equiv files on the RHEL 8 operating system.
  - id: 5615
    title: "There must be no shosts.equiv files on the RHEL 8 operating system."
    description: "The 'shosts.equiv' files are used to configure host-based authentication via SSH. Host-based authentication does not provide sufficient protection against unauthorized access."
    rationale: "Host-based authentication does not provide sufficient protection as it bypasses interactive identification and two-factor authentication."
    remediation: "Remove any found 'shosts.equiv' files from the system."
    compliance:
      - stid_id: ["RHEL-08-010460"]
      - stig_severity: ["1"]
    condition: none
    rules:
      # Check if any shosts.equiv files are present
      - 'c:find / -name "shosts.equiv" 2>/dev/null -> !r:.'

  # RHEL 8 must prevent the installation of software, patches, service packs, or OS components without verification they are digitally signed by an approved CA.
  - id: 5616
    title: "RHEL 8 must prevent installation of unsigned local packages."
    description: "The system must prevent the installation of software, patches, or device drivers unless they have been digitally signed by a certificate issued by an approved Certificate Authority (CA)."
    rationale: "Unsigned software may have been tampered with or provided by an untrusted vendor, which can lead to security issues."
    remediation: "Configure the operating system to verify software signatures by setting 'localpkg_gpgcheck=True' in the /etc/dnf/dnf.conf file."
    compliance:
      - stid_id: ["RHEL-08-010473"]
      - stig_severity: ["1"]
    condition: any
    rules:
      - 'f:/etc/dnf/dnf.conf -> !r:^# && r:^localpkg_gpgcheck=(True|1|yes)'
      - 'f:/etc/dnf/dnf.conf -> !r:^# && !r:^localpkg_gpgcheck=True'

  # Prevent installation of software, patches, or components from a repository without verification of digital signatures.
  - id: 5617
    title: "RHEL 8 must prevent installation of software from a repository without verification of signatures."
    description: "RHEL 8 must ensure that packages from repositories are digitally signed using a certificate from an approved CA to verify their integrity and authenticity."
    rationale: "Verifying the authenticity of software before installation ensures that it has not been tampered with and comes from a trusted vendor."
    remediation: "Configure the repository files in /etc/yum.repos.d/ to enable 'gpgcheck=1'."
    compliance:
      - stid_id: ["RHEL-08-010370"]
      - stig_severity: ["1"]
    condition: none
    rules:
      - 'f:/etc/yum.repos.d/*.repo -> !r:^# && r:^gpgcheck=1'

  # RHEL 8 must require authentication upon booting into single-user and maintenance modes on BIOS systems.
  - id: 5618
    title: "RHEL 8 must require authentication upon booting into single-user and maintenance modes on BIOS systems."
    description: "The system must require authentication before booting into single-user or maintenance mode to prevent unauthorized access to all files on the system."
    rationale: "Requiring authentication ensures that unauthorized users cannot access the system by entering single-user or maintenance mode."
    remediation: "Configure the system to require a grub bootloader password by setting a grub superuser password with the grub2-setpassword command."
    compliance:
      - stid_id: ["RHEL-08-010150"]
      - stig_severity: ["1"]
    condition: all
    rules:
      - 'f:/sys/firmware/efi -> !exists'
      - 'f:/boot/grub2/user.cfg -> !r:^# && r:^GRUB2_PASSWORD=grub.pbkdf2.sha512'

  # RHEL 8 must implement NIST FIPS-validated cryptography for digital signatures, cryptographic hashes, and data protection.
  - id: 5619
    title: "RHEL 8 must implement NIST FIPS-validated cryptography for digital signatures, cryptographic hashes, and data protection."
    description: "To comply with federal laws and directives, RHEL 8 must use FIPS-validated cryptography for key operations, such as generating cryptographic hashes, protecting data-at-rest, and provisioning digital signatures."
    rationale: "Weak or untested cryptography can compromise data security. Using FIPS-validated cryptographic modules ensures higher security standards approved by the federal government."
    remediation: "Enable FIPS mode on the system by running 'fips-mode-setup --enable' and rebooting the system."
    compliance:
      - stid_id: ["RHEL-08-010020"]
      - stig_severity: ["1"]
    condition: any
    rules:
      - 'c:fips-mode-setup --check -> r:FIPS mode is enabled'
      - 'c:grub2-editenv list | grep fips -> r:fips=1'
      - 'f:/proc/sys/crypto/fips_enabled -> r:1'

  # DISA STIG SEVERITY CATEGORY 2

  # DISA STIG SEVERITY CATEGORY 3

  - id: 32534
    title: "Must have the packages required to use the hardware random number generator entropy gatherer service."
    description: "The most important characteristic of a random number generator is its randomness, namely its ability to deliver random numbers that are impossible to predict."
    rationale: "The rngd service feeds random data from hardware device to kernel random device. Quality (non-predictable) random number generation is important for several security functions (i.e., ciphers)."
    remediation: "Run the following command to install rng-tools: # dnf install rng-tools"
    references:
      - "http://aide.sourceforge.net/stable/manual.html"
    compliance:
      - stid_id: ["RHEL-08-010472"]
      - stig_severity: ["3"]
    condition: all
    rules:
      - "c:rpm -q rng-tools -> r:rng-tools"
      
  # Ensure mounting of cramfs filesystems is disabled. (Automated)
  - id: 32500
    title: "Ensure mounting of cramfs filesystems is disabled."
    description: "The cramfs filesystem type is a compressed read-only Linux filesystem embedded in small footprint systems. A cramfs image can be used without having to first decompress the image."
    rationale: "Removing support for unneeded filesystem types reduces the local attack surface of the system. If this filesystem type is not needed, disable it."
    remediation: 'Edit or create a file in the /etc/modprobe.d/ directory ending in .conf with a line that reads install cramfs /bin/false and a line the reads blacklist cramfs. Example: # printf "install cramfs /bin/false blacklist cramfs " >> /etc/modprobe.d/cramfs.conf Run the following command to unload the cramfs module: # modprobe -r cramfs.'
    compliance:
      - stid_id: ["RHEL-08-040025"]
      - stig_severity: ["3"]
    condition: all
    rules:
      - "c:modprobe -n -v cramfs -> r:install /bin/false|Module cramfs not found"
      - "not c:lsmod -> r:cramfs"
      - 'd:/etc/modprobe.d/ -> r:\.*.conf -> r:^blacklist\s+cramfs'

  - id: 32519
    title: "Ensure separate partition exists for the system audit data path (/var/log/audit)."
    description: "The auditing daemon, auditd, stores log data in the /var/log/audit directory. A separate partition for this directory can protect the system from resource exhaustion and improve security by allowing for more granular control over the mount options."
    rationale: "Mounting /var/log/audit on a separate partition helps prevent resource exhaustion, allows for specific mount options like noexec, nosuid, and nodev, and protects critical audit data from being compromised."
    remediation: "Create a custom partition layout during installation or create a new partition for /var/log/audit on existing systems and update /etc/fstab accordingly."
    references:
      - "http://tldp.org/HOWTO/LVM-HOWTO/"
    compliance:
      - stid_id: ["RHEL-08-010542"]
      - stig_severity: ["3"]
    condition: all
    rules:
      - 'f:/etc/fstab -> r:/var/log/audit'
      - 'c:findmnt --kernel /var/log/audit -> r:^/var/log/audit\s'



  # RHEL 8 file integrity tool must be configured to verify Access Control Lists (ACLs).
  - id: 5643
    title: "RHEL 8 file integrity tool must verify Access Control Lists (ACLs)."
    description: "Verifying ACLs ensures that additional permissions beyond the standard file mode are checked for security compliance."
    remediation: "Ensure the 'acl' rule is present on all uncommented file and directory selection lists in the AIDE configuration."
    compliance:
      - stid_id: ["RHEL-08-040031"]
      - stig_severity: ["2"]
    condition: any
    rules:
      - 'f:/etc/aide.conf -> !r:^# && r:acl'


  # RHEL 8 file integrity tool must be configured to verify extended attributes.
  - id: 5642
    title: "RHEL 8 file integrity tool must verify extended attributes."
    description: "Verifying extended attributes ensures the integrity of additional file metadata with security implications."
    remediation: "Ensure the 'xattrs' rule is present on all uncommented file and directory selection lists in the AIDE configuration."
    compliance:
      - stid_id: ["RHEL-08-040030"]
      - stig_severity: ["2"]
    condition: any
    rules:
      - 'f:/etc/aide.conf -> !r:^# && r:xattrs'


  # RHEL 8 must disable IEEE 1394 (FireWire) support.
  - id: 5641
    title: "RHEL 8 must disable IEEE 1394 (FireWire) support."
    description: "Disabling FireWire (IEEE 1394) protects the system from potential vulnerabilities in the protocol."
    remediation: "Add 'install firewire-core /bin/false' and 'blacklist firewire-core' in /etc/modprobe.d/blacklist.conf."
    compliance:
      - stid_id: ["RHEL-08-040026"]
      - stig_severity: ["3"]
    condition: any
    rules:
      - 'f:/etc/modprobe.d/blacklist.conf -> !r:^# && r:^install firewire-core /bin/false'
      - 'f:/etc/modprobe.d/blacklist.conf -> !r:^# && r:^blacklist firewire-core'


  # RHEL 8 must disable the transparent inter-process communication (TIPC) protocol.
  - id: 5640
    title: "RHEL 8 must disable the transparent inter-process communication (TIPC) protocol."
    description: "Disabling the TIPC protocol prevents potential security risks associated with its implementation."
    remediation: "Add 'install tipc /bin/false' and 'blacklist tipc' in /etc/modprobe.d/blacklist.conf."
    compliance:
      - stid_id: ["RHEL-08-040024"]
      - stig_severity: ["3"]
    condition: any
    rules:
      - 'f:/etc/modprobe.d/blacklist.conf -> !r:^# && r:^install tipc /bin/false'
      - 'f:/etc/modprobe.d/blacklist.conf -> !r:^# && r:^blacklist tipc'


  # RHEL 8 must disable the stream control transmission protocol (SCTP).
  - id: 5639
    title: "RHEL 8 must disable the stream control transmission protocol (SCTP)."
    description: "Disabling the SCTP protocol prevents potential security risks associated with its implementation."
    remediation: "Add 'install sctp /bin/false' and 'blacklist sctp' in /etc/modprobe.d/blacklist.conf."
    compliance:
      - stid_id: ["RHEL-08-040023"]
      - stig_severity: ["3"]
    condition: any
    rules:
      - 'f:/etc/modprobe.d/blacklist.conf -> !r:^# && r:^install sctp /bin/false'
      - 'f:/etc/modprobe.d/blacklist.conf -> !r:^# && r:^blacklist sctp'


  # RHEL 8 must disable the controller area network (CAN) protocol.
  - id: 5638
    title: "RHEL 8 must disable the controller area network (CAN) protocol."
    description: "Disabling the CAN protocol prevents potential security risks associated with its implementation."
    remediation: "Add 'install can /bin/false' and 'blacklist can' in /etc/modprobe.d/blacklist.conf."
    compliance:
      - stid_id: ["RHEL-08-040022"]
      - stig_severity: ["3"]
    condition: any
    rules:
      - 'f:/etc/modprobe.d/blacklist.conf -> !r:^# && r:^install can /bin/false'
      - 'f:/etc/modprobe.d/blacklist.conf -> !r:^# && r:^blacklist can'


  # RHEL 8 must disable the asynchronous transfer mode (ATM) protocol.
  - id: 5637
    title: "RHEL 8 must disable the asynchronous transfer mode (ATM) protocol."
    description: "Disabling the ATM protocol prevents potential security risks associated with its implementation."
    remediation: "Add 'install atm /bin/false' and 'blacklist atm' in /etc/modprobe.d/blacklist.conf."
    compliance:
      - stid_id: ["RHEL-08-040021"]
      - stig_severity: ["3"]
    condition: any
    rules:
      - 'f:/etc/modprobe.d/blacklist.conf -> !r:^# && r:^install atm /bin/false'
      - 'f:/etc/modprobe.d/blacklist.conf -> !r:^# && r:^blacklist atm'


  # RHEL 8 must enable mitigations against processor-based vulnerabilities.
  - id: 5636
    title: "RHEL 8 must enable mitigations against processor-based vulnerabilities."
    description: "Kernel page-table isolation (PTI) mitigates the Meltdown vulnerability and strengthens kernel security."
    remediation: "Set 'pti=on' in GRUB configuration and persist after kernel updates."
    compliance:
      - stid_id: ["RHEL-08-040004"]
      - stig_severity: ["3"]
    condition: any
    rules:
      - 'c:grub2-editenv list | grep pti -> r:pti=on'
      - 'f:/etc/default/grub -> !r:^# && r:pti=on'


  # RHEL 8 must disable network management of the chrony daemon.
  - id: 5635
    title: "RHEL 8 must disable network management of the chrony daemon."
    description: "Disabling network management of the chrony daemon reduces the attack surface by limiting network exposure."
    remediation: "Set 'cmdport 0' in /etc/chrony.conf."
    compliance:
      - stid_id: ["RHEL-08-030742"]
      - stig_severity: ["3"]
    condition: any
    rules:
      - 'f:/etc/chrony.conf -> !r:^# && r:^cmdport 0'


  # RHEL 8 must disable the chrony daemon from acting as a server.
  - id: 5634
    title: "RHEL 8 must disable the chrony daemon from acting as a server."
    description: "Disabling the server functionality of the chrony daemon reduces the attack surface by limiting its exposure."
    remediation: "Set 'port 0' in /etc/chrony.conf."
    compliance:
      - stid_id: ["RHEL-08-030741"]
      - stig_severity: ["3"]
    condition: any
    rules:
      - 'f:/etc/chrony.conf -> !r:^# && r:^port 0'


  # RHEL 8 must enable Linux audit logging for the USBGuard daemon.
  - id: 5633
    title: "RHEL 8 must enable Linux audit logging for the USBGuard daemon."
    description: "Enabling Linux audit logging for USBGuard ensures that USB access and policy violations are logged for security analysis."
    remediation: "Set 'AuditBackend=LinuxAudit' in /etc/usbguard/usbguard-daemon.conf."
    compliance:
      - stid_id: ["RHEL-08-030603"]
      - stig_severity: ["3"]
    condition: any
    rules:
      - 'f:/etc/usbguard/usbguard-daemon.conf -> !r:^# && r:^AuditBackend=LinuxAudit'


  # RHEL 8 must allocate an audit_backlog_limit of sufficient size.
  - id: 5632
    title: "RHEL 8 must allocate an audit_backlog_limit of sufficient size."
    description: "An audit backlog limit of sufficient size ensures critical boot processes are captured before the audit daemon starts."
    remediation: "Set 'audit_backlog_limit=8192' in GRUB configuration and persist after kernel updates."
    compliance:
      - stid_id: ["RHEL-08-030602"]
      - stig_severity: ["3"]
    condition: any
    rules:
      - 'c:grub2-editenv list | grep audit_backlog_limit -> r:audit_backlog_limit=8192'
      - 'f:/etc/default/grub -> !r:^# && r:audit_backlog_limit=8192'


  # RHEL 8 must enable auditing of processes that start prior to the audit daemon.
  - id: 5631
    title: "RHEL 8 must enable auditing of processes that start prior to the audit daemon."
    description: "Enabling auditing of processes that start before the audit daemon ensures that critical early boot events are recorded."
    rationale: "Recording early boot events helps detect malicious behavior or system misconfigurations that occur before the audit daemon is started."
    remediation: "Ensure 'audit=1' is set in GRUB configuration and persists after kernel updates."
    compliance:
      - stid_id: ["RHEL-08-030601"]
      - stig_severity: ["3"]
    condition: any
    rules:
      - 'c:grub2-editenv list | grep audit -> r:audit=1'
      - 'f:/etc/default/grub -> !r:^# && r:audit=1'


  # RHEL 8 must resolve audit information before writing to disk.
  - id: 5630
    title: "RHEL 8 must resolve audit information before writing to disk."
    description: "Resolving audit information before writing to disk helps ensure that logs provide sufficient context for security investigations."
    rationale: "Enriched audit logs provide additional context that can help security teams detect and respond to incidents."
    remediation: "Ensure 'log_format=ENRICHED' is present in '/etc/audit/auditd.conf'."
    compliance:
      - stid_id: ["RHEL-08-030063"]
      - stig_severity: ["3"]
    condition: any
    rules:
      - 'f:/etc/audit/auditd.conf -> !r:^# && r:^log_format=ENRICHED'


  # RHEL 8 must display the date and time of the last successful account logon upon logon.
  - id: 5629
    title: "RHEL 8 must display the date and time of the last successful account logon upon logon."
    description: "Displaying the last logon time helps users identify unauthorized access."
    rationale: "Showing users when their last login occurred helps detect unauthorized access."
    remediation: "Ensure 'pam_lastlog.so showfailed' is present in the '/etc/pam.d/postlogin' file."
    compliance:
      - stid_id: ["RHEL-08-020340"]
      - stig_severity: ["3"]
    condition: any
    rules:
      - 'f:/etc/pam.d/postlogin -> !r:^# && r:pam_lastlog.so showfailed'


  # RHEL 8 must prevent users from disabling session control mechanisms.
  - id: 5628
    title: "RHEL 8 must prevent users from disabling session control mechanisms."
    description: "Tmux is a terminal multiplexer used to manage session control. Preventing users from disabling tmux ensures secure session control."
    rationale: "Disabling session control mechanisms can expose the system to security risks, including unauthorized access."
    remediation: "Ensure 'tmux' is not present in the '/etc/shells' file."
    compliance:
      - stid_id: ["RHEL-08-020042"]
      - stig_severity: ["3"]
    condition: any
    rules:
      - 'f:/etc/shells -> !r:^# && r:tmux'


  # RHEL 8 must limit the number of concurrent sessions to ten for all accounts.
  - id: 5627
    title: "RHEL 8 must limit the number of concurrent sessions to ten for all accounts."
    description: "Limiting the number of concurrent sessions reduces the risks associated with Denial of Service (DoS) attacks."
    rationale: "Restricting concurrent sessions helps ensure that system resources are not over-utilized and limits the impact of a potential Denial of Service (DoS) attack."
    remediation: "Set the 'maxlogins' to '10' by adding '* hard maxlogins 10' in '/etc/security/limits.conf' or a file under '/etc/security/limits.d/'."
    compliance:
      - stid_id: ["RHEL-08-020024"]
      - stig_severity: ["3"]
    condition: any
    rules:
      - 'f:/etc/security/limits.conf -> !r:^# && r:\* hard maxlogins 10'
      - 'f:/etc/security/limits.d/*.conf -> !r:^# && r:\* hard maxlogins 10'
      - 'f:/etc/security/limits.conf -> !r:^# && r:\* hard maxlogins [1-9][1-9]'
      - 'f:/etc/security/limits.d/*.conf -> !r:^# && r:\* hard maxlogins [1-9][1-9]'


  # RHEL 8 must use a separate file system for /var/log.
  - id: 5626
    title: "RHEL 8 must use a separate file system for /var/log."
    description: "Using a separate file system for '/var/log' can protect the system from failures due to a file system becoming full or failing."
    rationale: "Separate file systems for log directories protect the system from failures if logs consume excessive space."
    remediation: "Migrate the '/var/log' path onto a separate file system by adding an entry to /etc/fstab."
    compliance:
      - stid_id: ["RHEL-08-010541"]
      - stig_severity: ["3"]
    condition: any
    rules:
      - 'f:/etc/fstab -> !r:^# && r:/var/log'


  # RHEL 8 must use a separate file system for /var.
  - id: 5625
    title: "RHEL 8 must use a separate file system for /var."
    description: "Using a separate file system for '/var' can protect the system from failures due to a file system becoming full or failing."
    rationale: "Separate file systems for critical paths ensure that file system failures or overfills do not affect the entire system."
    remediation: "Migrate the '/var' path onto a separate file system by adding an entry to /etc/fstab."
    compliance:
      - stid_id: ["RHEL-08-010540"]
      - stig_severity: ["3"]
    condition: any
    rules:
      - 'f:/etc/fstab -> !r:^# && r:/var'


  # RHEL 8 must enable the hardware random number generator entropy gatherer service.
  - id: 5624
    title: "RHEL 8 must enable the hardware random number generator entropy gatherer service."
    description: "The 'rngd' service feeds random data from hardware devices to the kernel's random device. Quality random number generation is critical for cryptographic security."
    rationale: "A high-quality random number generator ensures unpredictable random values, which is crucial for cryptographic systems."
    remediation: "Start and enable the 'rngd' service by using 'systemctl start rngd' and 'systemctl enable rngd'."
    compliance:
      - stid_id: ["RHEL-08-010471"]
      - stig_severity: ["3"]
    condition: any
    rules:
      - 'c:systemctl is-enabled rngd -> r:enabled'
      - 'c:systemctl is-active rngd -> r:active'


  # YUM must remove all software components after updated versions have been installed on RHEL 8.
  - id: 5623
    title: "YUM must remove all software components after updated versions have been installed on RHEL 8."
    description: "Previous versions of software components may be exploited by adversaries if not removed after updates."
    rationale: "Cleaning up unneeded packages ensures that older, potentially vulnerable software is removed from the system, reducing the attack surface."
    remediation: "Set 'clean_requirements_on_remove=True' in the /etc/dnf/dnf.conf file to ensure old packages are removed after updates."
    compliance:
      - stid_id: ["RHEL-08-010440"]
      - stig_severity: ["3"]
    condition: any
    rules:
      - 'f:/etc/dnf/dnf.conf -> !r:^# && r:^clean_requirements_on_remove=(True|1|yes)'
      - 'f:/etc/dnf/dnf.conf -> !r:^# && !r:^clean_requirements_on_remove=(True|1|yes)'


  # RHEL 8 must prevent kernel profiling by unprivileged users.
  - id: 5622
    title: "RHEL 8 must prevent kernel profiling by unprivileged users."
    description: "Setting the 'kernel.perf_event_paranoid' kernel parameter to '2' prevents attackers from gaining additional system information as a non-privileged user."
    rationale: "Restricting kernel profiling prevents unauthorized information transfers and access to shared system resources by unprivileged users."
    remediation: "Ensure 'kernel.perf_event_paranoid=2' is set in the appropriate sysctl configuration files and remove any conflicting configurations."
    compliance:
      - stid_id: ["RHEL-08-010376"]
      - stig_severity: ["3"]
    condition: any
    rules:
      - 'c:sysctl kernel.perf_event_paranoid -> r:kernel.perf_event_paranoid = 2'
      - 'f:/etc/sysctl.d/*.conf -> !r:^# && r:^kernel.perf_event_paranoid=2'
      - 'f:/run/sysctl.d/*.conf -> !r:^# && r:^kernel.perf_event_paranoid=2'
      - 'f:/usr/local/lib/sysctl.d/*.conf -> !r:^# && r:^kernel.perf_event_paranoid=2'
      - 'f:/usr/lib/sysctl.d/*.conf -> !r:^# && r:^kernel.perf_event_paranoid=2'
      - 'f:/lib/sysctl.d/*.conf -> !r:^# && r:^kernel.perf_event_paranoid=2'
      - 'f:/etc/sysctl.conf -> !r:^# && r:^kernel.perf_event_paranoid=2'
      - 'f:/etc/sysctl.d/*.conf -> !r:^# && !r:^kernel.perf_event_paranoid=2'
      - 'f:/run/sysctl.d/*.conf -> !r:^# && !r:^kernel.perf_event_paranoid=2'
      - 'f:/usr/local/lib/sysctl.d/*.conf -> !r:^# && !r:^kernel.perf_event_paranoid=2'
      - 'f:/usr/lib/sysctl.d/*.conf -> !r:^# && !r:^kernel.perf_event_paranoid=2'
      - 'f:/lib/sysctl.d/*.conf -> !r:^# && !r:^kernel.perf_event_paranoid=2'
      - 'f:/etc/sysctl.conf -> !r:^# && !r:^kernel.perf_event_paranoid=2'

  # RHEL 8 must restrict access to the kernel message buffer.
  - id: 5620
    title: "RHEL 8 must restrict access to the kernel message buffer."
    description: "Restricting access to the kernel message buffer limits access to only root, preventing attackers from gaining additional system information as a non-privileged user."
    rationale: "Unauthorized access to kernel messages may reveal sensitive system information, increasing the risk of an attack."
    remediation: "Ensure the 'kernel.dmesg_restrict=1' parameter is set in /etc/sysctl.d/ or another system configuration file and remove any conflicting entries."
    compliance:
      - stid_id: ["RHEL-08-010375"]
      - stig_severity: ["3"]
    condition: any
    rules:
      - 'c:sysctl kernel.dmesg_restrict -> r:kernel.dmesg_restrict = 1'
      - 'f:/etc/sysctl.d/*.conf -> !r:^# && r:^kernel.dmesg_restrict=1'
      - 'f:/run/sysctl.d/*.conf -> !r:^# && r:^kernel.dmesg_restrict=1'
      - 'f:/usr/local/lib/sysctl.d/*.conf -> !r:^# && r:^kernel.dmesg_restrict=1'
      - 'f:/usr/lib/sysctl.d/*.conf -> !r:^# && r:^kernel.dmesg_restrict=1'
      - 'f:/lib/sysctl.d/*.conf -> !r:^# && r:^kernel.dmesg_restrict=1'
      - 'f:/etc/sysctl.conf -> !r:^# && r:^kernel.dmesg_restrict=1'
      - 'f:/etc/sysctl.d/*.conf -> !r:^# && !r:^kernel.dmesg_restrict=1'
      - 'f:/run/sysctl.d/*.conf -> !r:^# && !r:^kernel.dmesg_restrict=1'
      - 'f:/usr/local/lib/sysctl.d/*.conf -> !r:^# && !r:^kernel.dmesg_restrict=1'
      - 'f:/usr/lib/sysctl.d/*.conf -> !r:^# && !r:^kernel.dmesg_restrict=1'
      - 'f:/lib/sysctl.d/*.conf -> !r:^# && !r:^kernel.dmesg_restrict=1'
      - 'f:/etc/sysctl.conf -> !r:^# && !r:^kernel.dmesg_restrict=1'


  # RHEL 8 must ensure the SSH server uses strong entropy.
  - id: 5621
    title: "RHEL 8 must ensure the SSH server uses strong entropy."
    description: "The SSH server must be configured to use strong entropy by setting 'SSH_USE_STRONG_RNG=32' in the /etc/sysconfig/sshd file."
    rationale: "Using strong entropy is essential for generating random values in cryptographic systems, which helps ensure the security of SSH connections."
    remediation: "Add or modify 'SSH_USE_STRONG_RNG=32' in the /etc/sysconfig/sshd file and restart the SSH service."
    compliance:
      - stid_id: ["RHEL-08-010292"]
      - stig_severity: ["3"]
    condition: any
    rules:
      - 'f:/etc/sysconfig/sshd -> !r:^# && r:^SSH_USE_STRONG_RNG=32'
      - 'f:/etc/sysconfig/sshd -> !r:^# && !r:^SSH_USE_STRONG_RNG=32'


  - id: 32534
    title: "Must have policycoreutils package installed."
    description: "Without verification of the security functions, security functions may not operate correctly and the failure may go unnoticed."
    rationale: "Policycoreutils contains the policy core utilities that are required for basic operation of an SELinux-enabled system."
    remediation: "Run the following command to install policycoreutils: # dnf install policycoreutils"
    references:
      - "http://aide.sourceforge.net/stable/manual.html"
    compliance:
      - stid_id: ["RHEL-08-010171"]
      - stig_severity: ["3"]
    condition: all
    rules:
      - "c:rpm -q policycoreutils -> r:policycoreutils"
